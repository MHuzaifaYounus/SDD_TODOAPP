# OIDC Configuration Guidance:
# For secure cloud access (e.g., to Azure, GCP, AWS), it's highly recommended to use OpenID Connect (OIDC)
# instead of long-lived secrets.
#
# Steps:
# 1. Configure an OIDC Identity Provider in your cloud (e.g., Azure AD Workload Identity, AWS IAM Roles for Service Accounts, GCP Workload Identity).
# 2. Establish a trust relationship between your cloud and GitHub's OIDC provider.
# 3. Grant your GitHub Actions workflow permissions to access Kubernetes resources.
# 4. In your GitHub Actions workflow, acquire credentials using the appropriate cloud-specific action,
#    e.g., `azure/login@v1` with `enable-AzSPN` and `federated-credential`.
# 5. Remove `kubeconfig: ${{ secrets.KUBE_CONFIG }}` and use the acquired OIDC credentials for `k8s-set-context`.
#
# For more details, refer to your cloud provider's documentation on GitHub Actions OIDC integration.

name: Deploy to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # This is required for requesting the OIDC token
      contents: read  # This is required for checkout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies for Backend
        run: pip install flake8 # Assuming flake8 is used for linting
        working-directory: ./

      - name: Lint Python Backend
        run: flake8 .
        working-directory: ./

      - name: Install Python dependencies for Worker
        run: pip install flake8
        working-directory: ./services/worker

      - name: Lint Python Worker
        run: flake8 .
        working-directory: ./services/worker

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node.js dependencies for Frontend
        run: npm install
        working-directory: ./frontend

      - name: Lint Frontend
        run: npm run lint # Assuming a lint script is defined in package.json
        working-directory: ./frontend
        continue-on-error: true # Allow deployment even if linting fails, configurable

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: your-docker-username/todo-frontend:latest # Replace with your image name and tag

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: . # Assuming backend is at root level or specify its path
          push: true
          tags: your-docker-username/todo-backend:latest # Replace with your image name and tag

      - name: Build and push Worker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/worker
          push: true
          tags: your-docker-username/todo-worker:latest # Replace with your image name and tag

      - name: Deploy to Kubernetes
        uses: azure/k8s-set-context@v4 # Example for Azure, can be replaced for GKE/OKE
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }} # Kubeconfig for accessing the cluster
      - name: Deploy with Helm
        uses: azure/k8s-helm@v1
        with:
          action: upgrade
          chart: ./k8s/charts/todo-app
          release-name: todo-app-release
          namespace: default
          atomic: true
          values: |
            frontend.image.tag=latest
            backend.image.tag=latest
            worker.image.tag=latest
